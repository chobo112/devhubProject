<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
   xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">


<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>devhub</title>

<link rel="stylesheet"
   href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" />
<!--아이콘용-->
<script type="text/javascript" src="../../static/js/jquery-3.7.1.min.js"
   th:src="@{js/jquery-3.7.1.min.js}"></script>
<link rel="stylesheet"
   href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />

<th:block th:replace="~{fragments/configure::configure}"></th:block>
</head>

<body class="bg-gray-100">
   <th:block th:replace="~{fragments/header::headerFragment}"></th:block>

   <script>
      function register() {
         alert("글을 등록하겠습니까? 글 수정은 불가능합니다.");
      }
   </script>

   <div class="max-w-4xl mx-auto py-10">
      <header
         class="flex justify-between items-center pb-6 border-b border-gray-300">
         <h1 class="text-3xl font-bold">게시판 작성</h1>
      </header>

      <div class="mt-8">

         <form action="submit_board" method="post">
            <div class="mb-4">
               <div class="bg-white p-6 rounded shadow-sm">
                  <h2 class="text-xl font-bold">
                     글제목 <input type="text"
                        class="w-full border border-gray-300 rounded px-3 py-2 my-3 text-base"
                        placeholder="프로젝트 제목을 간단하게 소개해주세요" name="board_title">

                  </h2>
                  <div class="grid grid-cols-2 gap-8 mb-4">

                     <div>
                        <label class="block text-base font-medium mb-1 font-serif">프로젝트명</label>
                        <input type="text"
                           class="w-full border border-gray-300 rounded px-3 py-2 text-sm"
                           placeholder="프로젝트명" name="pr_title" required />
                     </div>
                     <!-- 금액 이랑 게시판 유형 바꿀꺼 -->
                     <div id="boardTypeSelect">
                        <label class="block text-base font-medium mb-1 font-serif">게시판
                           유형선택</label> <select
                           class="w-full border border-gray-300 rounded px-3 py-2 text-sm"
                           name="board_type" id="boardTypeSelect"
                           onchange="togglePrPriceInput(this)">
                           <option value="1">멘티모집 게시판</option>
                           <option value="2">멘토&멤버 모집게시판</option>
                           <option value="3">멤버모집 게시판</option>
                        </select>
                     </div>



                     <!-- 금액 이랑 게시판 유형 바꿀꺼 -->


                     <div>
                        <label class="block text-base font-medium mb-1 font-serif">카카오
                           링크</label> <input type="text"
                           class="w-full border border-gray-300 rounded px-3 py-2 text-sm"
                           placeholder="카카오링크" name="kakaolink" />
                     </div>
                     <div>
                        <label class="block text-base font-medium mb-1 font-serif">카카오
                           링크 비밀번호</label> <input type="text"
                           class="w-full border border-gray-300 rounded px-3 py-2 text-sm"
                           placeholder="카카오링크 비밀번호" name="kakaopw" />
                     </div>

                     <!-- 여기서 해당하는 유형의 게시판을 넣어줘야지 멘토주도면 멘토게시판으로 박히고, 컬럼도 멘토주도가 들어가게됨 -->
                  </div>
                  <div class="grid grid-cols-2 gap-8 mb-4">
                     <div>
                        <label class="block text-base font-medium mb-1 font-serif">진행방식
                        </label> <select
                           class="w-full border border-gray-300 rounded px-3 py-2 text-sm"
                           name="pr_type">
                           <option value="0">온라인</option>
                           <option value="1">오프라인</option>
                           <option value="2">온라인/오프라인</option>
                        </select>
                     </div>


                     <!--지역의 경우에는 온라인일떄는 안나오도록!!-->
                     <div id="locationSelection">
                        <label class="block text-base font-medium mb-1">지역 유저
                           테이블로 들어가야할듯?</label>
                        <div class="flex items-center">

                           <!-- 로컬코드는  옵션으로 선택하게 하는중임-->
                           <select
                              class="w-full border border-gray-300 rounded px-3 py-2 text-sm"
                              name="local_code">
                              <option value="" disabled selected>구 선택</option>
                              <!-- 서울시에 해당하는 구/군 옵션 추가 -->
                              <option value="1111000000">종로구</option>
                              <option value="1114000000">중구</option>
                              <option value="1117000000">용산구</option>
                              <option value="1120000000">성동구</option>
                              <option value="1121500000">광진구</option>
                              <option value="1123000000">동대문구</option>
                              <option value="1126000000">중랑구</option>
                              <option value="1129000000">성북구</option>
                              <option value="1130500000">강북구</option>
                              <option value="1132000000">도봉구</option>
                              <option value="1135000000">노원구</option>
                              <option value="1138000000">은평구</option>
                              <option value="1141000000">서대문구</option>
                              <option value="1144000000">마포구</option>
                              <option value="1147000000">양천구</option>
                              <option value="1150000000">강서구</option>
                              <option value="1153000000">구로구</option>
                              <option value="1154500000">금천구</option>
                              <option value="1156000000">영등포구</option>
                              <option value="1159000000">동작구</option>
                              <option value="1162000000">관악구</option>
                              <option value="1165000000">서초구</option>
                              <option value="1168000000">강남구</option>
                              <option value="1171000000">송파구</option>
                              <option value="1174000000">강동구</option>
                           </select>
                        </div>

                     </div>

                  </div>
                  <div class="grid grid-cols-2 gap-8 mb-4">
                  <div id="priceInput">
                     <label class="grid grid-cols-2 gap-8 mb-4">금액</label>
                     <input type="number"
                        class="w-full border border-gray-300 rounded px-3 py-2 text-sm"
                        placeholder="금액" name="pr_price" id="pr_price" required min="0"
                        max="10000000" oninput="checkMaxValue(this)" />
                     <p id="maxValueWarning" style="color: red; display: none;">1000만원을
                        초과할 수 없습니다.</p>
                  </div>
                  </div>


                  <div class="grid grid-cols-3 gap-4 mb-4">
                     <div>
                        <label class="block text-base font-medium mb-1">모집마감일자 </label>
                        <input type="date" id="mo_EndInput"
                           class="w-full border border-gray-300 rounded px-3 py-2 text-sm"
                           value="2024-03-15" name="board_edate" required />
                     </div>
                     <div>
                        <label class="block text-base font-medium mb-1">시작일자 </label> <input
                           type="date" id="pr_startDateInput"
                           class="w-full border border-gray-300 rounded px-3 py-2 text-sm"
                           value="2024-03-17" name="pr_sdate" required />
                     </div>
                     <div>
                        <label class="block text-base font-medium mb-1">프로젝트예상종료기간
                        </label> <input type="date" id="pr_deadlineInput"
                           class="w-full border border-gray-300 rounded px-3 py-2 text-sm"
                           value="2024-03-20" name="pr_edate" required />
                     </div>

                  </div>

                  <!--팀원 모집인원 부분!!
                         최소 모집인원 입력란 추가 -->
                  <div class="grid grid-cols-2 gap-8 mb-4">
                     <div id="personnel-section">
                        <div>
                           <label class="block text-base font-medium mb-1">최소 모집인원
                           </label> <input type="number" id="minRecruitment1" value="1" min="1"
                              name="min_people"
                              class="w-full border border-gray-300 rounded px-3 py-2 text-sm"
                              placeholder="최소 모집 인원" />
                        </div>
                     </div>

                     <div id="tot_round">
                        <div>
                           <label class="block text-base font-medium mb-1">총회차(단위기준
                              1달)</label> <input type="number" id="totRound" value="6" min="1"
                              name="tot_round"
                              class="w-full border border-gray-300 rounded px-3 py-2 text-sm"
                              placeholder="총회차" readonly />
                        </div>
                     </div>
                  </div>



                  <!-- 팀원 그룹과, 멘토 그룹 감싸줌 -->
                  <div id="teamAndmentorGroupWrap">
                     <div id="teamMemberGroupWrap" class="flex items-end">
                        <ul id="teamMemberGroupUl" class="mb-5">
                           <li class="flex items-center"><input type="hidden"
                              value="1" name="groupIndexArray[1]" />
                              <h2 class="block text-base font-medium mb-1 mr-4">그룹</h2>
                              <div>
                                 <input type="text" list="techStackDataList"
                                    class="techStackInput bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white ml-0"
                                    placeholder="기술 스택을 선택하세요" />
                                 <datalist id="techStackDataList">
                                    <option th:each="techStack : ${techStackList}"
                                       th:value="${techStack.skill_name}"></option>
                                 </datalist>
                              </div>
                              <div id="skillImgDiv"
                                 class="skillImgDiv ml-4 flex gap-2 items-center max-w-300 max-h-200 overflow-auto">
                                 <!-- 스킬 이미지 들어가는 공간 -->
                                 <input type="hidden" id="hiddenImgIds"
                                    name="skillImgArray[1]">
                              </div>
                              <div class="ml-4 flex items-center">
                                 <label for="minRecruitment"
                                    class="block text-base font-medium mb-1 mr-2">인원</label> <input
                                    type="number" id="minRecruitment" name="groupNumArray[1]"
                                    value="1" min="1"
                                    class="w-full border border-gray-300 rounded px-3 py-2 text-sm"
                                    placeholder="최소 모집 인원" required />
                              </div></li>
                        </ul>
                        <div title="그룹을 하나 추가합니다.">
                           <div onclick="addGroup()"
                              class="ml-4 mb-5 bg-gray-400 text-white px-3 py-1 mt-3 rounded cursor-pointer">+</div>
                        </div>
                        <div title="맨마지막 그룹을 제거합니다.">
                           <div onclick="removeGroup()"
                              class="ml-4 mb-5 bg-gray-400 text-white px-3 py-1 mt-3 rounded cursor-pointer">-</div>
                        </div>
                        <div title="맨마지막 그룹의 선택된 기술스택들만 리셋합니다.">
                           <svg onclick="resetGroup()"
                              class="w-8 h-8 text-gray-800 dark:text-white ml-4 mb-5 mt-3 bg-gray-400 rounded cursor-pointer"
                              aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
                              fill="none" viewBox="0 0 24 24">
                               <path stroke="currentColor"
                                 stroke-linecap="round" stroke-linejoin="round"
                                 stroke-width="2"
                                 d="M17.7 7.7A7.1 7.1 0 0 0 5 10.8M18 4v4h-4m-7.7 8.3A7.1 7.1 0 0 0 19 13.2M6 20v-4h4" />
                          </svg>
                        </div>
                     </div>
                     <hr />



                     <div id="mentorGroupWrap" class="flex items-center">
                        <h3>멘토 그룹</h3>
                        <ul id="mentorGroupUl" class="mb-5">
                           <li class="flex items-center"><input type="hidden"
                              value="0" name="groupIndexArray[0]" />
                              <h2 class="block text-base font-medium mb-1 mr-4">멘토</h2>
                              <div>
                                 <input type="text" list="techStackDataList"
                                    class="techStackInput bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white ml-0"
                                    placeholder="기술 스택을 선택하세요" />
                                 <datalist id="techStackDataList">
                                    <option th:each="techStack : ${techStackList}"
                                       th:value="${techStack.skill_name}"></option>
                                 </datalist>
                              </div>
                              <div
                                 class="skillImgDiv gap-2 flex items-center max-w-300 max-h-200 overflow-auto">
                                 <!--  스킬 이미지 들어가는 공간  -->
                                 <input type="hidden" id="hiddenImgIds"
                                    name="skillImgArray[0]">
                              </div>
                              <div class="ml-4 flex items-center">
                                 <label for="minRecruitment"
                                    class="block text-base font-medium mb-1 mr-2">인원</label> <input
                                    type="number" id="minRecruitment" name="groupNumArray[0]"
                                    value="1" min="1"
                                    class="w-full border border-gray-300 rounded px-3 py-2 text-sm"
                                    placeholder="최소 모집 인원" readonly />
                              </div></li>
                        </ul>
                     </div>
                  </div>


                  <div>
                     <h2 class="text-xl font-bold mb-2">프로젝트에 대해 상세하게 적어주세요.</h2>
                     <!-- 500px 에서 250 px 로 줄임 -->
                     <div
                        class="bg-white p-6 rounded shadow-sm h-[250px] overflow-y-auto">
                        <div class="mb-4">
                           <textarea
                              class="w-full border border-gray-300 rounded px-3 py-2 text-sm lg:text-lg"
                              placeholder="프로젝트의 성격에 맞게 작성 자신의 프로젝트를 소개해주세요"
                              name="board_content" rows="8"></textarea>
                        </div>
                     </div>

                  </div>
               </div>
            </div>
            <div class="flex justify-center mt-2">
               <button type="submit" class="px-6 py-2 rounded"
                  style="background-color: black; color: white;">등록하기</button>
            </div>
         </form>
      </div>

   </div>




   <script>
      const selectedSkillNameArray = [];
      var groupAndSkillIdList = {};
      $(document)
            .on(
                  'change',
                  '#teamAndmentorGroupWrap li input[class*="techStackInput"]',
                  function() {

                     let skillName = $(this).val();
                     if (!selectedSkillNameArray.includes(skillName)) {
                        selectedSkillNameArray.push(skillName);
                     } else {
                        selectedSkillNameArray.length = 0;
                     }

                     console.log('selectedSkillNameArray:',
                           selectedSkillNameArray);
                     console.log('skillName:', skillName);

                     var selectedLi = $(this).closest('li'); // 현재 이벤트가 발생한 input의 부모 li를 찾음
                     var groupId = selectedLi.find(
                           'input[name*="groupIndexArray"]').val();
                     console.log('groupId:', groupId);

                     $
                           .ajax({
                              type : 'POST',
                              url : '/getSkillImgAjax',
                              dataType : 'json',
                              traditional : true,
                              data : {
                                 selectedSkillNameArray : selectedSkillNameArray
                              },
                              success : function(resultSkillList) {
                                 console.log('resultSkillList:',
                                       resultSkillList);

                                 var length = resultSkillList.length;

                                 // 마지막 객체에만 작업 수행
                                 if (length > 0) {
                                    let lastTechStack = resultSkillList[length - 1];
                                    selectedLi
                                          .find(
                                                "div[class*='skillImgDiv']")
                                          .append(
                                                $('<img>')
                                                      .attr(
                                                            {
                                                               'src' : lastTechStack.skill_img,
                                                               'style' : 'width: 50px; height: 50px;',
                                                               //'name': groupSkillListId,
                                                               'id' : lastTechStack.skill_id,
                                                               'alt' : ''
                                                            }));
                                 }
                                 ;//if

                                 const liElements = $('#teamAndmentorGroupWrap li');

                                 liElements
                                       .each(function() {
                                          const groupLiId = $(
                                                this)
                                                .find(
                                                      'input[name*="groupIndexArray"]')
                                                .val();
                                          const imgIds = $(this)
                                                .find(
                                                      'div[class*="skillImgDiv"] > img')
                                                .map(
                                                      function() {
                                                         return this.id;
                                                      })
                                                .get();
                                          groupAndSkillIdList[groupLiId] = imgIds;

                                          const hiddenImgInput = $(
                                                this)
                                                .find(
                                                      'input[name*="skillImgArray"]');
                                          hiddenImgInput
                                                .val(imgIds);
                                          console.log('imgIds:',
                                                imgIds);
                                          console
                                                .log(
                                                      'hiddenImgInput.val:',
                                                      hiddenImgInput
                                                            .val());
                                       });

                                 // 결과 객체를 출력합니다.
                                 console.log('groupAndSkillIdList:',
                                       groupAndSkillIdList);

                              }//success
                           })//ajax
                     $(this).val(""); //input 입력창 비우기

                  })//document

      // pr_title 50byte제한 -> 넘어가는 경우에 알람메시지
      $(document).ready(function() {
         // 프로젝트명 입력 필드의 값이 변경될 때마다 실행됩니다.
         $('input[name="pr_title"]').on('input', function() {
            var maxLength = 20; // 허용된 최대 길이
            var title = $(this).val(); // 입력된 프로젝트명
            if (title.length > maxLength) {
               // 프로젝트명이 최대 길이를 초과하는 경우 자르고 입력합니다.
               $(this).val(title.substring(0, maxLength));
            }
         });
      });

      var groupIndex = 1;
      // 그룹 추가 함수
      function addGroup() {
         let originGroupLi = $("#teamMemberGroupUl").find("li").last();
         let clonedGroupLi = originGroupLi.clone();
         console.log("그룹추가");

         groupIndex++;

         clonedGroupLi.find("input").val("");
         clonedGroupLi.find("#skillImgDiv img").remove();
         clonedGroupLi.find("input[name*='skillImgArray']").attr("name",
               "skillImgArray" + "[" + groupIndex + "]")
         clonedGroupLi.find("input[name*='groupNumArray']").attr("name",
               "groupNumArray" + "[" + groupIndex + "]")
         clonedGroupLi.find("input[name*='groupIndexArray']").attr("name",
               "groupIndexArray" + "[" + groupIndex + "]")

         clonedGroupLi.find('input[type="hidden"]:first').val(groupIndex);
         clonedGroupLi.appendTo($("#teamMemberGroupUl"));
      }
      // 그룹 제거 함수
      function removeGroup() {
         // 그룹이 1개인 경우에는 제거하지 않고 종료
         if (groupIndex === 1) {
            return;
         }

         let lastGroupLi = $("#teamMemberGroupUl").find("li").last();
         lastGroupLi.remove();
         groupIndex--; // 그룹이 제거될 때 그룹 인덱스를 감소시킴
      }

      // 그룹 리셋 함수
      function resetGroup() {

         let lastGroupLi = $("#teamMemberGroupUl").find("li").last();
         lastGroupLi.find("#skillImgDiv img").remove();
      }

      //온라인인 경우에는 데이터를 숨기기 
      function handleProgressTypeChange() {
         const progressTypeSelect = document
               .querySelector('select[name="pr_type"]');
         const locationSelectionDiv = document
               .getElementById('locationSelection');

         // 진행 방식이 온라인인 경우 지역 선택란 숨기기
         if (progressTypeSelect.value === '0') {
            locationSelectionDiv.style.display = 'none';
         } else {
            // 온라인이 아닌 경우 지역 선택란 보이기
            locationSelectionDiv.style.display = 'block';
         }

      }

      // 페이지 로드시 처리
      handleProgressTypeChange();

      // 진행방식 변경 이벤트를 감지하여 처리
      document.querySelector('select[name="pr_type"]').addEventListener(
            'change', handleProgressTypeChange);

      // 시작일자와 예상 종료 기간을 비교하여 유효성을 검사하는 함수
      function validateInputs() {
         const pr_startDateInput = document
               .getElementById('pr_startDateInput');
         const pr_deadlineInput = document
               .getElementById('pr_deadlineInput');
         const mo_EndInput = document.getElementById('mo_EndInput');

         const pr_projectstartDate = new Date(pr_startDateInput.value);
         const pr_projectdeadline = new Date(pr_deadlineInput.value);
         const mo_recruitendDate = new Date(mo_EndInput.value);
         const today = new Date();

         let error = false;

         // 프로젝트 시작일자를 선택하지 않았을 경우 에러 처리
         // 오늘이 가장 빠른 날짜인지 확인
         if (pr_projectstartDate < today || mo_recruitendDate < today
               || pr_projectdeadline < today) {
            alert("날짜를 현재 날짜 이후로 선택해주세요.");
            pr_startDateInput.value = "";
            pr_deadlineInput.value = "";
            mo_EndInput.value = "";
            error = true;
         }

         // 프로젝트 시작일이 모집 마감일보다 이전인 경우 에러 처리
         if (pr_projectstartDate < mo_recruitendDate) {
            alert("프로젝트 시작일은 모집마감일 이후로 가능합니다. 다시 선택해주세요.");
            pr_startDateInput.value = "";
            error = true;
         }

         // 프로젝트 종료일이 프로젝트 시작일보다 이후인 경우 에러 처리
         if (pr_projectdeadline <= pr_projectstartDate) {
            alert("프로젝트 종료일은 프로젝트 시작일 이후로 설정해주세요. 다시 선택해주세요.");
            pr_deadlineInput.value = "";
            error = true;
         }

         // 모집 마감일이 프로젝트 시작일보다 이후인 경우 에러 처리
         if (mo_recruitendDate >= pr_projectstartDate) {
            alert("모집 마감일은 프로젝트 시작일 이후로 설정해주세요. 다시 선택해주세요.");
            mo_EndInput.value = "";
            error = true;
         }

         // 에러가 없는 경우 입력 필드의 스타일 초기화
         if (!error) {
            pr_startDateInput.style.border = '';
            pr_deadlineInput.style.border = '';
            mo_EndInput.style.border = '';

            const totRound = Math
                  .ceil((pr_projectdeadline - pr_projectstartDate)
                        / (1000 * 60 * 60 * 24 * 30));
            document.getElementById('totRound').value = totRound;
         }
      }

      document.getElementById('pr_startDateInput').addEventListener('change',
            validateInputs);
      document.getElementById('pr_deadlineInput').addEventListener('change',
            validateInputs);
      document.getElementById('mo_EndInput').addEventListener('change',
            validateInputs);

      //게시판 유형 -> 멘토&팀원모집 선택시에만 => 멘토모집 인원 고를수 있는 부분 나오도록
      document.addEventListener('DOMContentLoaded', function() {
         var boardTypeSelect = document
               .querySelector('select[name="board_type"]');
         var mentorGroupWrap = document.getElementById('mentorGroupWrap');
         //const mentorGroupIndex = document.querySelector('#mentorGroupWrap input[name="groupIndexArray[0]"]');
         // 초기 상태 설정
         toggleMentorGroup(boardTypeSelect.value);

         // 게시판 유형 선택이 변경될 때 마다 실행
         boardTypeSelect.addEventListener('change', function() {
            toggleMentorGroup(this.value);
         });

         // 멘토 그룹의 가시성을 제어하는 함수
         function toggleMentorGroup(boardType) {
            if (boardType === '2') {
               //document.querySelector('#mentorGroupWrap input[name="groupIndexArray[0]"]')
               //mentorGroupIndex.removeAttribute("disabled");
               //mentorGroupWrap.removeAttribute("disabled");
               mentorGroupWrap.style.display = 'block';
            } else {
               //mentorGroupWrap.setAttribute("disabled","");
               //mentorGroupIndex.setAttribute("disabled","");
               mentorGroupWrap.style.display = 'none';
            }
         }
      });

      // 팀원모집일 경우에는 금액이 안 나오고 0으로 넘겨주자
      function togglePrPriceInput(selectElement) {
         var priceInput = document.getElementById("pr_price");
         if (priceInput) {
            if (selectElement.value == "3") {
               priceInput.style.display = "none";
               priceInput.value = "0";
            } else {
               priceInput.style.display = "block";
            }
         } else {
            console.error("Element with id 'pr_price' not found.");
         }
      }

      function checkMaxValue(input) {
         if (input.value > 10000000) {
            document.getElementById("maxValueWarning").style.display = "block";
            input.value = 10000000; // 입력된 값이 20억을 초과하는 경우 최댓값인 20억으로 설정
         } else {
            document.getElementById("maxValueWarning").style.display = "none";
         }
      }
   </script>

   <!-- 푸터 -->
   <th:block th:replace="~{fragments/footer::footerFragment}"></th:block>
</body>

</html>